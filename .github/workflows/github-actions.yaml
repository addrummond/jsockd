name: jsockd CI pipeline
run-name: ${{ github.actor }}
on:
  push:
  pull_request:
jobs:
  CI:
    runs-on: ubuntu-24.04
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up MacOS Cross Compiler
        uses: Timmmm/setup-osxcross@v2
        with:
          osx-version: "15.5"

      - name: Set up tools
        run: ./ci.sh setup

      - name: Log versions
        run: ./ci.sh log_versions

      - name: Check JSockD version constants
        run: ./ci.sh check_jsockd_version_constants

      - name: Run shellcheck
        run: ./ci.sh shellcheck

      - name: Check jsockd_server formatting
        run: |
          ./ci.sh check_jsockd_server_formatting

      - name: Cache QuickJS build output
        id: cache-quickjs-build-output
        uses: actions/cache@v4
        with:
          path: |
            .scratch/quickjs
            tools-bin
          # This key is based on the hash of the build script to ensure cache
          # is updated when the script changes.
          key: ${{ runner.os }}-quickjs-${{ hashFiles('build_quickjs.sh') }}-${{ hashFiles('quickjs.patch') }}-${{ hashFiles('fil-c-quickjs.patch') }}

      - name: Build QuickJS
        if: steps.cache-quickjs-build-output.outputs.cache-hit != 'true'
        run: ./ci.sh build_quickjs

      - name: Build jsockd_server
        run: |
          ./ci.sh build_jsockd_server

      - name: Run jsockd_server tests
        run: ./ci.sh run_jsockd_server_tests

      - name: Cross-compile jsockd_server for Linux/ARM64
        run: |
          ./ci.sh build_jsockd_server_linux_arm64

      - name: Cross-compile jsockd_server for MacOS/ARM64
        run: |
          ./ci.sh build_jsockd_server_darwin_aarch64

      - name: Compile jsockd_server with Fil-C for Linux/x86_64
        run: |
          ./ci.sh build_jsockd_server_linux_x86_64_filc

      - name: Run jsockd_server Valgrind tests
        run: ./ci.sh run_jsockd_server_valgrind_tests

      - name: Run jsockd_server Valgrind tests with non-newline sep
        run: ./ci.sh run_jsockd_server_valgrind_tests_with_non_newline_sep

      - name: Run jsockd_server Valgrind eval tests
        run: ./ci.sh run_jsockd_server_valgrind_eval_tests

      - name: Run jsockd_server E2E tests
        run: ./ci.sh run_jsockd_server_e2e_tests

      - name: Run JSockD Go client tests
        run: ./ci.sh run_jsockd_go_client_tests

      - name: Run jsockd_server stress tests implemented in Go (Debug build)
        run: ./ci.sh run_jsockd_go_stress_tests_with_debug_build

      - name: Run jsockd_server stress tests implemented in Go (Release build)
        run: ./ci.sh run_jsockd_go_stress_tests_with_release_build

      - name: Run jsockd_server idle timeout stress tests implemented in Go (Debug build)
        run: ./ci.sh run_jsockd_go_idle_timeout_stress_tests_with_debug_build

      - name: Run jsockd_server idle timeout stress tests implemented in Go (Release build)
        run: ./ci.sh run_jsockd_go_idle_timeout_stress_tests_with_release_build

      - name: Package binaries
        env:
          JSOCKD_RELEASE_ARTEFACT_PRIVATE_SIGNING_KEY: ${{ secrets.JSOCKD_RELEASE_ARTEFACT_PRIVATE_SIGNING_KEY }}
        run: ./ci.sh package_binaries

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jsockd-release-artifacts
          path: |
            ${{ github.workspace }}/jsockd_server/jsockd-*.tar.gz
            ${{ github.workspace }}/jsockd_server/checksums.txt
            ${{ github.workspace }}/jsockd_server/ed25519_signatures.txt
  release:
    runs-on: ubuntu-24.04
    needs: CI
    if: github.ref_type == 'tag'
    permissions:
      contents: write
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: jsockd-release-artifacts
          path: jsockd_server
      - name: Create release
        env:
          GITHUB_TOKEN: ${{ github.TOKEN }}
        run: ./ci.sh github_actions_create_release $(basename "${{ github.ref }}")
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      - name: Build libquickjs.a and qjsc.exe (with diagnostics)
        shell: cmd
        timeout-minutes: 10
        run: |
          reg add "HKCU\Software\Microsoft\Windows\Windows Error Reporting" /v DontShowUI /t REG_DWORD /d 1 /f
          echo Y | winget install -e --id GnuWin32.Make
          echo Y | winget install -e --id JernejSimoncic.Wget
          set PATH="C:\msys64\usr\bin;%PATH%"
          cd ${{ github.workspace }}
          rem Download ProcDump for crash dump capture
          "%LOCALAPPDATA%\Microsoft\WinGet\Links\wget.exe" https://download.sysinternals.com/files/Procdump.zip
          set EXE="%programfiles%\git\bin\sh.exe"
          rem 63e9f73771301cb19be6dafdc010bca6dd42a06561c756c1d3726fa369105d06a1916e33d3b737dd2a6e8ab17ae26b1bfce061fdea520a5adaf5d41cb245c20b
          %EXE% -c "unzip Procdump.zip"
          rem Prepare diagnostics directories and files
          mkdir dumps 2>NUL
          set CMD_ARGS=build_quickjs.sh windows_x64_msvc
          rem Guarded SxS trace: prefer System32, fall back to Sysnative; skip if unavailable
          set "SXS_EXE=%SystemRoot%\System32\sxstrace.exe"
          if not exist "%SXS_EXE%" set "SXS_EXE=%SystemRoot%\Sysnative\sxstrace.exe"
          set "DO_SXS=1"
          if not exist "%SXS_EXE%" set "DO_SXS="
          if defined DO_SXS (
            start /b "" "%SXS_EXE%" Trace -logfile:sxs.etl
          ) else (
            echo sxstrace.exe not available; skipping Side-by-Side trace
          )
          rem Run the build command under ProcDump to capture unhandled exceptions
          if exist "%CD%\procdump64.exe" (
            procdump64.exe -accepteula
            procdump64.exe -h -l -t -e -ma -at 60 -x "%CD%\dumps" %EXE% %CMD_ARGS%
          ) else (
            echo ProcDump not found, running without crash dump capture
            %EXE% %CMD_ARGS%
          )
          rem Stop and parse SxS trace if we started it
          if defined DO_SXS (
            "%SXS_EXE%" StopTrace
            "%SXS_EXE%" Parse -logfile:sxs.etl -outfile:sxs.txt
            echo ==== Parsed SxS trace ====
            type sxs.txt
          )
      - name: Upload Windows build diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-diagnostics
          path: |
            sxs.etl
            sxs.txt
            dumps/*.dmp
